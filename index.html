<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenamiento Supervisor MASH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0A2463 0%, #1e3a8a 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .option-button {
            transition: all 0.3s ease;
            border-left: 4px solid #3E92CC;
        }
        
        .option-button:hover:not(.disabled) {
            transform: translateX(4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .correct-answer {
            background: linear-gradient(135deg, #10b981, #065f46) !important;
            color: white !important;
            font-weight: bold !important;
            transform: translateX(0px) !important;
        }
        
        .incorrect-answer {
            background: linear-gradient(135deg, #ef4444, #991b1b) !important;
            color: white !important;
            font-weight: bold !important;
            transform: translateX(0px) !important;
        }
        
        .disabled {
            pointer-events: none;
        }
        
        .progress-bar {
            transition: width 0.6s ease-in-out;
        }
        
        .module-button {
            transition: all 0.3s ease;
        }
        
        .module-button:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .module-button.active {
            background: linear-gradient(135deg, #3E92CC, #1e40af);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(62, 146, 204, 0.4);
        }
        
        /* Estilo para módulo completado y bloqueado */
        .module-button.completed {
            background: #d1fae5; /* Color claro para indicar completado */
            color: #065f46;
            border-color: #10b981;
            opacity: 1 !important;
            cursor: default !important;
        }

        .rh-card {
            background: linear-gradient(135deg, #f0f9ff, #dbeafe);
            border-left: 6px solid #0284c7;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3E92CC, #1e40af);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(62, 146, 204, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #065f46);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #991b1b);
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
        }
        
        .floating-element {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="text-white">

    <div class="container mx-auto px-4 py-8 max-w-5xl">

        <!-- Header Section -->
        <header class="text-center mb-10 fade-in">
            <div class="floating-element">
                <h1 class="text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-400 mb-4">
                    Entrenamiento Supervisor MASH
                </h1>
                <h2 class="text-xl md:text-2xl font-medium text-blue-200 mb-8">
                    Verificación de Competencia - Nivel Intermedio
                </h2>
            </div>
            
            <!-- Global Progress Bar (Hidden initially) -->
            <div id="global-progress" class="w-full max-w-2xl mx-auto mb-8 hidden">
                <div class="glass-effect rounded-full h-4 overflow-hidden">
                    <div id="progress-fill" class="progress-bar bg-gradient-to-r from-green-400 to-blue-500 h-full rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p class="text-sm mt-3 text-blue-200" id="progress-text">Progreso: 0%</p>
            </div>
        </header>

        <!-- Data Form Section -->
        <div id="supervisor-data-form" class="glass-effect rounded-2xl p-6 md:p-8 mb-8 card-shadow fade-in">
            <h3 class="text-2xl font-bold mb-6 text-yellow-300 flex items-center">
                <span class="mr-3">👤</span>
                Datos del Participante
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <input 
                    type="text" 
                    id="input-nombre" 
                    placeholder="Nombre Completo *" 
                    class="p-4 rounded-lg bg-white/10 backdrop-blur border border-white/20 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"
                    required
                >
                <input 
                    type="text" 
                    id="input-puesto" 
                    placeholder="Puesto *" 
                    class="p-4 rounded-lg bg-white/10 backdrop-blur border border-white/20 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"
                    required
                >
                <input 
                    type="text" 
                    id="input-depto" 
                    placeholder="Departamento *" 
                    class="p-4 rounded-lg bg-white/10 backdrop-blur border border-white/20 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"
                    required
                >
                <input 
                    type="email" 
                    id="input-email" 
                    placeholder="Email corporativo" 
                    class="p-4 rounded-lg bg-white/10 backdrop-blur border border-white/20 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"
                >
                <input 
                    type="text" 
                    id="input-supervisor" 
                    placeholder="Responsable inmediato" 
                    class="p-4 rounded-lg bg-white/10 backdrop-blur border border-white/20 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all"
                >
            </div>
            
            <button 
                id="start-quiz-button" 
                onclick="validateAndStartQuiz()" 
                class="w-full btn-primary text-white font-bold py-4 px-8 rounded-lg text-lg"
            >
                🚀 Comenzar Entrenamiento
            </button>
            <p class="text-sm text-blue-200 mt-2 text-center">* Campos obligatorios</p>
        </div>

        <!-- RH Dashboard (Hidden initially) -->
        <div id="rh-dashboard" class="rh-card rounded-2xl p-6 mb-8 card-shadow hidden fade-in">
            <h3 class="text-2xl font-bold text-blue-800 mb-6 flex items-center">
                <span class="mr-3">📊</span>
                Dashboard Recursos Humanos
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="metric-card text-center p-6 rounded-xl">
                    <div class="text-4xl font-black text-blue-600 mb-2" id="completion-rate">0%</div>
                    <div class="text-sm font-medium text-gray-600">Tasa de Completitud</div>
                </div>
                <div class="metric-card text-center p-6 rounded-xl">
                    <div class="text-4xl font-black text-blue-600 mb-2" id="competency-level">---</div>
                    <div class="text-sm font-medium text-gray-600">Nivel de Competencia</div>
                </div>
                <div class="metric-card text-center p-6 rounded-xl">
                    <div class="text-4xl font-black text-blue-600 mb-2" id="time-invested">0 min</div>
                    <div class="text-sm font-medium text-gray-600">Tiempo Invertido</div>
                </div>
            </div>
        </div>

        <!-- Warning Box (Hidden initially) -->
        <div id="warning-box" class="glass-effect rounded-xl p-4 mb-8 border-l-4 border-red-400 hidden fade-in">
            <p class="font-bold text-sm">
                <span class="text-2xl mr-2">⚠️</span>
                <span class="text-yellow-300">ADVERTENCIA IMPORTANTE:</span> 
                Por favor, reflexione cuidadosamente su respuesta. Una vez seleccionada, la opción es definitiva y no podrá ser modificada.
            </p>
        </div>

        <!-- Module Selector (Hidden initially) -->
        <div id="module-selector" class="glass-effect rounded-xl p-6 mb-8 hidden fade-in">
            <h3 class="text-xl font-bold mb-4 text-center text-yellow-300">Módulos de Entrenamiento</h3>
            <div class="flex flex-wrap justify-center gap-3" id="module-buttons-container">
                <!-- Module buttons will be inserted here -->
            </div>
        </div>

        <!-- Quiz Area (Hidden initially) -->
        <div id="quiz-area" class="bg-white rounded-2xl card-shadow hidden">
            
            <!-- Quiz Content -->
            <div id="quiz-content" class="p-6 md:p-8">
                <div class="mb-6">
                    <p class="text-sm font-bold text-red-600 mb-2" id="module-title"></p>
                    <div class="border-b border-gray-200 pb-4 mb-6">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2" id="question-text"></h3>
                        <p class="text-sm text-gray-500" id="question-progress"></p>
                    </div>
                </div>

                <!-- Answer Options -->
                <div id="options-container" class="space-y-4 mb-6">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Feedback Area -->
                <div id="feedback-area" class="p-4 rounded-xl border hidden">
                    <p class="font-bold text-sm mb-2" id="feedback-title"></p>
                    <p class="text-sm" id="feedback-explanation"></p>
                </div>

                <!-- Navigation -->
                <div class="flex justify-end mt-6">
                    <button 
                        id="next-button" 
                        onclick="nextQuestion()" 
                        class="btn-primary text-white font-bold py-3 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" 
                        disabled
                    >
                        Siguiente Pregunta →
                    </button>
                </div>
            </div>
            
            <!-- Module Summary Screen -->
            <div id="module-summary-screen" class="text-center p-8 hidden">
                <div class="mb-6">
                    <h3 class="text-3xl font-black text-blue-600 mb-4">✅ Módulo Completado</h3>
                    <p class="text-xl font-bold text-gray-700 mb-3" id="module-summary-title"></p>
                    <p class="text-3xl font-black mb-4" id="module-score-display"></p>
                    <p class="text-lg text-gray-600 mb-6 max-w-2xl mx-auto" id="module-summary-message"></p>
                </div>
                
                <button 
                    id="continue-button" 
                    onclick="goToNextModule()" 
                    class="btn-success text-white font-bold py-3 px-8 rounded-lg text-lg"
                >
                    Continuar →
                </button>
            </div>

            <!-- Final Results Screen -->
            <div id="final-results-screen" class="text-center p-8 hidden">
                <div class="mb-8">
                    <h3 class="text-4xl font-black text-red-600 mb-4">🎉 ENTRENAMIENTO COMPLETO</h3>
                    <p class="text-2xl font-bold text-gray-700 mb-3">Calificación Final</p>
                    <p class="text-6xl font-black mb-6" id="final-score-display"></p>
                    
                    <div id="results-dashboard" class="mb-8">
                        <!-- Results dashboard will be inserted here -->
                    </div>

                    <p class="text-lg text-gray-600 mb-8 max-w-3xl mx-auto" id="final-summary-message"></p>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col md:flex-row gap-4 justify-center mb-6">
                    <button onclick="shareResults()" class="btn-primary text-white font-bold py-3 px-6 rounded-lg">
                        📋 Generar Reporte
                    </button>
                    <button onclick="generateCertificate()" class="btn-success text-white font-bold py-3 px-6 rounded-lg">
                        🏆 Generar Certificado
                    </button>
                    <div class="relative">
                        <button onclick="toggleEmailMenu()" class="btn-danger text-white font-bold py-3 px-6 rounded-lg" id="email-button">
                            📧 Enviar a RL ▼
                        </button>
                        <div id="email-menu" class="absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl border hidden z-10 min-w-48">
                            <button onclick="sendToRLClient()" class="w-full px-4 py-3 text-left text-gray-700 hover:bg-gray-100 rounded-t-lg">
                                📧 Cliente de Email
                            </button>
                            <button onclick="sendToRLGmail()" class="w-full px-4 py-3 text-left text-gray-700 hover:bg-gray-100 rounded-b-lg border-t border-gray-200">
                                🟢 Gmail
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Report Output (Hidden initially) -->
                <div id="share-output" class="bg-gray-100 p-4 rounded-lg border text-left text-gray-800 text-sm whitespace-pre-wrap hidden mt-6"></div>
            </div>

        </div>

    </div>

    <script>
        const quizData = [
            {
                id: 1,
                title: 'Módulo 1: Introducción a Componentes y Regulaciones',
                questions: [
                    {
                        q: '¿Cuál es el propósito principal de una **Auditoría Ambiental** para su empresa?',
                        options: ['Obtener financiamiento de organismos internacionales.', 'Determinar el nivel de salubridad y seguridad laboral.', 'Verificar el cumplimiento de la normatividad ambiental vigente y buscar mejoras.'],
                        answer: 2,
                        explanation: '¡Correcto! La Auditoría Ambiental es un examen sistemático para **verificar el cumplimiento legal** y establecer conclusiones para la mejora continua del desempeño ambiental.'
                    },
                    {
                        q: '¿Qué componente ambiental se relaciona directamente con la verificación de la **calidad de las descargas** de agua residual de la planta?',
                        options: ['Aire.', 'Suelo y Subsuelo.', 'Agua.'],
                        answer: 2,
                        explanation: '¡Correcto! El componente **Agua** es regulado por la CONAGUA a través de límites permisibles para las descargas (NOM-001) y la gestión del consumo.'
                    },
                    {
                        q: '¿Qué autoridad ambiental en México es la principal responsable de otorgar permisos federales de impacto ambiental y establecer límites de contaminantes?',
                        options: ['Procuraduría Federal de Protección al Ambiente (PROFEPA).', 'Secretaría de Medio Ambiente y Recursos Naturales (SEMARNAT).', 'Comisión Nacional del Agua (CONAGUA).'],
                        answer: 1,
                        explanation: '¡Correcto! **SEMARNAT** es la autoridad normativa y administrativa (otorga licencias y permisos federales). PROFEPA se enfoca en la vigilancia y sanción.'
                    },
                    {
                        q: 'El concepto de **Riesgo Ambiental** se enfoca principalmente en la identificación de:',
                        options: ['El número de accidentes laborales de los últimos 5 años.', 'El incumplimiento de la NOM-001.', 'Factores de peligrosidad de las sustancias y la vulnerabilidad del entorno.'],
                        answer: 2,
                        explanation: '¡Correcto! El Riesgo Ambiental evalúa la probabilidad de daño al entorno al cruzar la **peligrosidad** de una sustancia con la **vulnerabilidad** del lugar (ej. suelo, cuerpos de agua).'
                    }
                ]
            },
            {
                id: 2,
                title: 'Módulo 2: La Documentación MASH y el Control de Requisitos Legales',
                questions: [
                    {
                        q: '¿Cuál de estas leyes es crucial para el supervisor MASH, ya que regula la gestión del **uso y explotación de los cuerpos de agua nacionales**?',
                        options: ['Ley Federal del Trabajo (LFT).', 'Ley de Aguas Nacionales (LAN).', 'Ley General del Equilibrio Ecológico (LGEEPA).'],
                        answer: 1,
                        explanation: '¡Correcto! La **LAN** regula el uso, explotación y aprovechamiento de las aguas nacionales, incluyendo los permisos y concesiones de CONAGUA.'
                    },
                    {
                        q: 'El uso de la **SQCI-JUD-MA-002 Matriz ERLO** de la empresa le permite al supervisor MASH:',
                        options: ['Calcular el volumen de residuos peligrosos generados anualmente.', 'Conocer las obligaciones de la LGEEPA y la LGPGIR que aplican a su proceso.', 'Diseñar el organigrama del área MASH.'],
                        answer: 1,
                        explanation: '¡Correcto! La SQCI-JUD-MA-002 Matriz ERLO es la herramienta interna que **traduce la ley** en **obligaciones específicas** de cumplimiento para cada proceso de la empresa.'
                    },
                    {
                        // PREGUNTA 3 ACTUALIZADA con la nueva opción
                        q: 'Según el Plan de Manejo de SQCI, ¿cuál de las siguientes es una regla obligatoria que el Departamento MASH debe vigilar para el Almacén Temporal de Residuos de Manejo Especial (RME)?',
                        options: [
                            'inspección fisica semestral para evidencia en la COA.', 
                            'El almacén no debe exceder un 80% de su capacidad y el periodo de almacenamiento no debe rebasar 6 meses.', 
                            'El personal debe ingresar sin equipo de protección personal para evitar contaminarlo.', 
                            'Las bitácoras de entrada y salida solo necesitan registrarse al finalizar el trimestre.'
                        ],
                        answer: 1,
                        explanation: '¡Correcto! La regla obligatoria es que **el almacén no debe exceder un 80% de su capacidad y el periodo de almacenamiento no debe rebasar 6 meses**, asegurando una gestión eficiente y segura.'
                    },
                    {
                        q: 'La implementación de **controles operacionales** (ej. procedimientos, instructivos) es necesaria para el supervisor con el fin de:',
                        options: ['Aumentar la producción de Ácido Nítrico.', 'Asegurar la mejora continua del sistema de gestión MASH.', 'Minimizar los impactos ambientales derivados de las actividades diarias.'],
                        answer: 2,
                        explanation: '¡Correcto! Los controles operacionales son acciones concretas (como cerrar un envase) cuyo objetivo directo es **minimizar los impactos ambientales** (ej. derrame, emisión) y laborales.'
                    }
                ]
            },
            {
                id: 3,
                title: 'Módulo 3: Residuos Peligrosos (RP) y la Aplicación del Plan de Manejo',
                questions: [
                    {
                        q: 'Según la NOM-052, ¿cuál de estos valores de pH clasifica a un residuo como **Corrosivo**?',
                        options: ['Un pH entre 6.0 y 8.0.', 'Un pH de 5.0 o un pH de 9.0.', 'Un pH igual o menor a 2.0 o igual o mayor a 12.5.'],
                        answer: 2,
                        explanation: '¡Correcto! La característica de corrosividad es binaria: se cumple si el pH es extremadamente ácido (≤2.0) o extremadamente básico (≥12.5).'
                    },
                    {
                        q: 'El Plan de Manejo Integral de RP (SQCI-MASH-PN-014) establece una jerarquía. ¿Cuál es el orden correcto de las prioridades de gestión?',
                        options: ['Disposición Final, Valorización, Prevención.', 'Valorización, Prevención, Disposición Final.', 'Prevención/Minimización, Valorización (reutilización), Disposición Final.'],
                        answer: 2,
                        explanation: '¡Correcto! La máxima prioridad es **evitar la generación** (Prevención/Minimización), seguida de **reutilizar/reciclar** (Valorización), y la Disposición Final es la última opción.'
                    },
                    {
                        q: 'De acuerdo con el Reglamento de la LGPGIR, el Almacenamiento Temporal de RP debe contar con pretiles o muros de contención. ¿Cuál es la función de esta infraestructura?',
                        options: ['Evitar que personal no autorizado ingrese al almacén.', 'Servir como barrera para la recolección de residuos no peligrosos.', 'Contener derrames para evitar que los líquidos contaminen el suelo o drenajes.'],
                        answer: 2,
                        explanation: '¡Correcto! El pretil o **muro de contención** (o dique) es el dispositivo de seguridad para retener cualquier derrame y facilitar la limpieza, protegiendo el suelo y el agua.'
                    },
                    {
                        q: '¿Cuál es el significado completo del acrónimo CRETIB, utilizado para clasificar las características de peligrosidad de los residuos?',
                        options: ['Características, Riesgo, Explosión, Toxicidad, Incompatible y Biodiverso.', 'Corrosivo, Reactivo, Explosivo, Tóxico, Inflamable y Biológico.', 'Central de Residuos Ecológicos, Tratamiento, Incineración y Biodegradación.'],
                        answer: 1,
                        explanation: '¡Correcto! CRETIB significa **Corrosivo, Reactivo, Explosivo, Tóxico, Inflamable y Biológico**. Es la clasificación oficial mexicana para determinar la peligrosidad de residuos según la NOM-052.'
                    },
                    {
                        q: '¿Cuál de los siguientes no es un requisito obligatorio del **Manifiesto de RP** para la disposición final?',
                        options: ['La firma del generador y del transportista.', 'El número de identificación del residuo y su cantidad.', 'La copia de la Licencia de Funcionamiento de la SEMARNAT.'],
                        answer: 2,
                        explanation: '¡Correcto! La Licencia de Funcionamiento la requiere la planta para operar (Módulo 5), pero no es parte del Manifiesto. El Manifiesto registra el flujo del residuo.'
                    },
                    {
                        q: 'Un supervisor detecta que se mezcló un residuo inflamable con un residuo corrosivo. Esta acción es incorrecta porque:',
                        options: ['Aumenta el volumen de RME generado.', 'Viola la prohibición de mezclar residuos incompatibles, creando un riesgo de reacción química.', 'Afecta únicamente la estética del almacén.'],
                        answer: 1,
                        explanation: '¡Correcto! La **mezcla de residuos incompatibles** es una prohibición clave (NOM-052) ya que puede causar fuego, explosiones o liberación de gases tóxicos.'
                    }
                ]
            },
            {
                id: 4,
                title: 'Módulo 4: Gestión del Agua (Descargas, Monitoreo y Tratamiento)',
                questions: [
                    {
                        q: '¿A qué se refiere el parámetro **Demanda Química de Oxígeno (DQO)**, uno de los contaminantes básicos monitoreados en las descargas de agua residual?',
                        options: [
                            'Es la cantidad de oxígeno disuelto necesario para oxidar la materia orgánica biodegradable.',
                            'Es la medida de la acidez o basicidad del agua residual.',
                            'Es la cantidad de oxígeno que se requiere para oxidar la materia orgánica e inorgánica mediante un agente químico.'
                        ],
                        answer: 2,
                        explanation: '¡Correcto! La DQO es la **cantidad de oxígeno que se requiere para oxidar la materia orgánica e inorgánica mediante un agente químico**. Se utiliza para medir la carga contaminante de las descargas.'
                    },
                    {
                        q: 'El **Límite Permisible** en las descargas de agua residual se define como:',
                        options: ['El valor máximo que la empresa puede pagar por un contaminante.', 'El valor que no debe ser excedido en el agua descargada a cuerpos receptores propiedad de la Nación.', 'El volumen total de agua tratada al día.'],
                        answer: 1,
                        explanation: '¡Correcto! El Límite Permisible es un valor normativo de concentración de contaminantes (ej. SST, DQO, Grasas y Aceites) que **no debe rebasarse** para proteger los cuerpos de agua.'
                    },
                    {
                        q: 'Según el título de concesión del agua, ¿cuál es la fuente de abastecimiento de SQCI en materia de agua?',
                        options: ['Rio tonala.', 'Río Huazuntlán.', 'Arroyo Acotope.'],
                        answer: 1,
                        explanation: '¡Correcto! El **Río Huazuntlán** es la fuente de abastecimiento de agua autorizada para SQCI según consta en el título de concesión otorgado por CONAGUA.'
                    },
                    {
                        q: 'De acuerdo con la Ley de Aguas Nacionales (LAN), ¿cuál es la definición de "Aguas Residuales"?',
                        options: [
                            'Son únicamente las aguas provenientes de usos industriales que contienen contaminantes tóxicos.', 
                            'Son las aguas que se originan solo en el uso público urbano y doméstico.', 
                            'Son aquellas aguas que han sido objeto de un uso previo y que tienen una composición alterada.', 
                            'Son las aguas de composición variada provenientes de las descargas de usos público urbano, doméstico, industrial, comercial, de servicios, agrícola, pecuario, de las plantas de tratamiento y, en general, de cualquier uso, así como la mezcla de ellas.'
                        ],
                        answer: 3,
                        explanation: '¡Correcto! La definición legal de la LAN (Artículo 3, Fracción IV) es amplia e incluye las aguas de composición variada provenientes de prácticamente **cualquier uso y la mezcla de ellas**.'
                    },
                    {
                        q: 'Los informes de resultados de muestreo y análisis de la calidad del agua deben registrarse ante:',
                        options: ['La SEMARNAT.', 'La Comisión Nacional del Agua (CONAGUA).', 'El Servicio de Administración Tributaria (SAT).'],
                        answer: 1,
                        explanation: '¡Correcto! La **CONAGUA** es la autoridad responsable de administrar los datos de la calidad del agua de las descargas y verificar el cumplimiento de la LAN y la NOM-001.'
                    }
                ]
            },
            {
                id: 5,
                title: 'Módulo 5: Emisiones a la Atmósfera y Reporte de GEI',
                questions: [
                    {
                        q: '¿Cuál es la autorización clave que requiere la industria química (Fuente Fija de Jurisdicción Federal) para operar y emitir contaminantes a la atmósfera?',
                        options: ['Certificado de Industria Limpia.', 'Licencia de Funcionamiento Ambiental.', 'Manifiesto de Generación Anual.'],
                        answer: 1,
                        explanation: '¡Correcto! La **Licencia de Funcionamiento** (otorgada por SEMARNAT) es la autorización obligatoria para fuentes fijas de jurisdicción federal, como la industria química.'
                    },
                    {
                        q: '¿Cuál es el umbral de Emisiones Directas o Indirectas que obliga a su empresa a reportar los Gases de Efecto Invernadero (GEI)?',
                        options: ['10,000 Toneladas de Bióxido de Carbono Equivalente (tCO₂e) anuales.', '25,000 Toneladas de Bióxido de Carbono Equivalente (tCO₂e) anuales.', '50,000 Toneladas de Bióxido de Carbono Equivalente (tCO₂e) anuales.'],
                        answer: 1,
                        explanation: '¡Correcto! El umbral legal para ser un **Establecimiento Sujeto a Reporte** en el Registro Nacional de Emisiones (RENE) es de **25,000 tCO₂e anuales**.'
                    },
                    {
                        q: '¿Qué debe hacer la Fuente Fija para garantizar que las emisiones no rebasen los niveles máximos permisibles?',
                        options: ['Instalar sistemas de aire acondicionado en el área de la chimenea.', 'Integrar un inventario de emisiones y emplear equipos de control.', 'Llenar el Manifiesto de Residuos de Manejo Especial.'],
                        answer: 1,
                        explanation: '¡Correcto! Debe emplear equipos de control (ej. filtros, depuradores) y documentar su desempeño a través de un **inventario** y bitácoras.'
                    },
                    {
                        q: 'La información de Emisiones de GEI y la de residuos peligrosos se reporta anualmente a la autoridad a través de:',
                        options: ['La Matriz de Requisitos Legales.', 'La Cédula de Operación Anual (COA).', 'El Inventario Nacional de Emisiones.'],
                        answer: 1,
                        explanation: '¡Correcto! La **COA** es el mecanismo único para reportar anualmente a SEMARNAT los datos consolidados de emisiones, residuos y consumo de agua/energía.'
                    },
                    {
                        q: 'En los sistemas de gestión ambiental, se diferencian claramente dos conceptos: el Aspecto Ambiental y el Impacto Ambiental. ¿Cuál es la relación de causa y efecto correcta entre estos términos?',
                        options: ['El Impacto Ambiental es la causa (la interacción de la actividad) y el Aspecto Ambiental es el efecto (la alteración en el medio).', 'El Aspecto Ambiental es la causa o elemento de la actividad de la organización que puede interactuar con el medio, generando un Impacto Ambiental (el cambio o la consecuencia).', 'Ambos términos se refieren a la consecuencia negativa de las operaciones sobre el medio ambiente, por lo que son sinónimos.'],
                        answer: 1,
                        explanation: '¡Correcto! El **Aspecto Ambiental** es la causa (elemento de la actividad que interactúa con el medio) y el **Impacto Ambiental** es el efecto o consecuencia (el cambio que se produce en el medio ambiente).'
                    }
                ]
            },
            {
                id: 6,
                title: 'Módulo 6: Remediación de Suelos y Respuesta a Contingencias',
                questions: [
                    {
                        q: 'La industria química se clasifica como Actividad Altamente Riesgosa (AAR) en función de:',
                        options: ['El número de empleados sindicalizados.', 'Las características de peligrosidad y el volumen de sustancias que se manejan.', 'La cantidad de agua descargada a cuerpos receptores.'],
                        answer: 1,
                        explanation: '¡Correcto! La clasificación AAR se basa en el **tipo y volumen de sustancias peligrosas** (Tóxicas, Inflamables, Explosivas, etc.) manejadas en la instalación.'
                    },
                    {
                        q: '¿Cuál es una prohibición estricta en el manejo de suelos contaminados (durante una remediación o emergencia)?',
                        options: ['Utilizar laboratorios acreditados para el muestreo final.', 'Mezclar suelos contaminados con suelos no contaminados para diluir el contaminante.', 'Solicitar planos georeferenciados del sitio contaminado.'],
                        answer: 1,
                        explanation: '¡Correcto! La dilución está estrictamente **prohibida** por la norma. El suelo contaminado debe ser tratado o confinado, no mezclado.'
                    },
                    {
                        q: '¿Qué información esencial debe contener la documentación de un Plan de Remediación de Suelos por una emergencia?',
                        options: ['El Manifiesto de Movimiento de RP de los últimos 5 años.', 'Planos del lugar georeferenciados con coordenadas UTM y la propuesta de la técnica de remediación.', 'El currículum vitae del supervisor MASH.'],
                        answer: 1,
                        explanation: '¡Correcto! La autoridad requiere información técnica precisa como **coordenadas UTM** y la **propuesta de la técnica** (biorremediación, confinamiento, etc.) para su aprobación.'
                    },
                    {
                        q: 'Dentro de las estrategias para la minimización de residuos peligrosos, ¿qué acción se recomienda específicamente para los envases que contuvieron sustancias peligrosas en SQCI?',
                        options: ['Disponer de inmediato todos los envases de productos químicos, ya que no pueden volver a usarse.', 'Reutilizar los envases que estén en buenas condiciones para contener el mismo tipo de material o uno compatible.', 'Quemar los envases vacíos para reducir su volumen antes de enviarlos a disposición final.'],
                        answer: 1,
                        explanation: '¡Correcto! La **reutilización de envases** en buenas condiciones para el mismo material o uno compatible es una estrategia clave de minimización, siempre que se mantenga la integridad del envase y la compatibilidad química.'
                    },
                    {
                        q: 'El objetivo principal del Plan de Contingencias ante Derrames (SQCI-MASH-PN-016) es:',
                        options: ['Proporcionar instrucciones para el mantenimiento preventivo de equipos.', 'Proporcionar instrucciones para una **respuesta oportuna y eficiente** ante derrames de RP.', 'Definir el flujo para el reporte anual de emisiones GEI.'],
                        answer: 1,
                        explanation: '¡Correcto! El objetivo central de todo Plan de Contingencia es la **respuesta operativa** inmediata para minimizar los riesgos y el impacto ambiental de un incidente.'
                    }
                ]
            }
        ];

        // State variables
        let currentModuleId = 1;
        let currentQuestionIndex = 0;
        let moduleScore = 0;
        let isAnswered = false;
        let totalScore = 0;
        let totalQuestions = 0;
        let totalModules = quizData.length;
        let completedModules = 0;
        // moduleResults contendrá un ÚNICO registro por módulo completado para evitar doble conteo.
        let moduleResults = []; 
        let startTime = new Date();
        let trainingData = {};
        
        let supervisorData = {
            nombre: '',
            puesto: '',
            departamento: '',
            email: '',
            supervisor: ''
        };

        // DOM elements
        const quizArea = document.getElementById('quiz-area');
        const moduleSelector = document.getElementById('module-selector');
        const quizContent = document.getElementById('quiz-content');
        const moduleSummaryScreen = document.getElementById('module-summary-screen');
        const finalResultsScreen = document.getElementById('final-results-screen');
        const moduleTitle = document.getElementById('module-title');
        const questionText = document.getElementById('question-text');
        const questionProgress = document.getElementById('question-progress');
        const optionsContainer = document.getElementById('options-container');
        const feedbackArea = document.getElementById('feedback-area');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackExplanation = document.getElementById('feedback-explanation');
        const nextButton = document.getElementById('next-button');
        const moduleSummaryTitle = document.getElementById('module-summary-title');
        const moduleScoreDisplay = document.getElementById('module-score-display');
        const moduleSummaryMessage = document.getElementById('module-summary-message');
        const finalScoreDisplay = document.getElementById('final-score-display');
        const finalSummaryMessage = document.getElementById('final-summary-message');
        const shareOutput = document.getElementById('share-output');
        const resultsDashboard = document.getElementById('results-dashboard');

        function initializeApp() {
            quizData.forEach(module => {
                totalQuestions += module.questions.length;
            });
            
            // Hide all sections initially
            document.getElementById('global-progress').classList.add('hidden');
            document.getElementById('rh-dashboard').classList.add('hidden');
            document.getElementById('warning-box').classList.add('hidden');
            document.getElementById('module-selector').classList.add('hidden');
            quizArea.classList.add('hidden');
        }

        function updateGlobalProgress() {
            const totalPossibleQuestions = quizData.reduce((sum, module) => sum + module.questions.length, 0);
            
            // Contar solo las preguntas contestadas una vez
            let answeredQuestionsCount = 0;
            moduleResults.forEach(result => {
                answeredQuestionsCount += result.total;
            });

            // Si el módulo actual no se ha completado, sumamos el progreso actual
            if (!moduleResults.some(r => r.id === currentModuleId)) {
                 answeredQuestionsCount += currentQuestionIndex;
            }

            // CORRECCIÓN 2: Asegurar que el progreso marque 100% si completedModules == totalModules
            let progressPercent = 0;
            if (completedModules === totalModules) {
                 progressPercent = 100;
            } else {
                 progressPercent = Math.round((answeredQuestionsCount / totalPossibleQuestions) * 100);
            }
            
            document.getElementById('progress-fill').style.width = progressPercent + '%';
            document.getElementById('progress-text').textContent = `Progreso: ${progressPercent}%`;
        }

        function validateAndStartQuiz() {
            supervisorData.nombre = document.getElementById('input-nombre').value.trim();
            supervisorData.puesto = document.getElementById('input-puesto').value.trim();
            supervisorData.departamento = document.getElementById('input-depto').value.trim();
            supervisorData.email = document.getElementById('input-email').value.trim();
            supervisorData.supervisor = document.getElementById('input-supervisor').value.trim();

            if (!supervisorData.nombre || !supervisorData.puesto || !supervisorData.departamento) {
                alert("Por favor, complete los campos obligatorios (Nombre, Puesto, Departamento) antes de comenzar.");
                return;
            }

            trainingData = {
                participante: supervisorData,
                startTime: new Date(),
                responses: []
            };

            // Hide form and show quiz elements
            document.getElementById('supervisor-data-form').classList.add('hidden');
            document.getElementById('global-progress').classList.remove('hidden');
            document.getElementById('warning-box').classList.remove('hidden');
            document.getElementById('module-selector').classList.remove('hidden');

            createModuleButtons();
            selectModule(1);
        }

        function createModuleButtons() {
            const container = document.getElementById('module-buttons-container');
            container.innerHTML = '';
            
            quizData.forEach((module, index) => {
                const button = document.createElement('button');
                const moduleId = module.id;
                button.innerHTML = `Módulo ${moduleId}`;
                button.className = 'module-button py-3 px-6 rounded-lg font-bold text-sm border-2 border-blue-300 text-blue-200 hover:text-white';
                button.onclick = () => selectModule(moduleId);
                button.dataset.moduleId = moduleId;
                
                const isCompleted = moduleResults.some(result => result.id === moduleId);

                if (index > 0) {
                    // Un módulo está disponible si el módulo anterior (id-1) está en moduleResults.
                    const previousModuleId = quizData[index - 1].id;
                    const isPreviousCompleted = moduleResults.some(result => result.id === previousModuleId);
                    
                    if (!isPreviousCompleted && !isCompleted) {
                        button.disabled = true;
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
                
                // Bloquear y marcar como completado si ya se contestó
                if (isCompleted) {
                    button.disabled = true;
                    button.classList.add('completed');
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                    button.classList.remove('text-blue-200', 'hover:text-white'); // Remover estilos de interactividad para completado
                }
                
                container.appendChild(button);
            });
        }

        function selectModule(moduleId) {
            // REGLA 1: Bloquear módulo si ya está completado
            const isCompleted = moduleResults.some(result => result.id === moduleId);
            if (isCompleted) {
                // Notificación en pantalla de que no se puede repetir
                return;
            }

            currentModuleId = moduleId;
            const buttons = document.querySelectorAll('.module-button');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.moduleId) === moduleId) {
                    btn.classList.add('active');
                }
            });
            startQuiz();
        }

        function startQuiz() {
            moduleScore = 0;
            currentQuestionIndex = 0;
            isAnswered = false;

            quizArea.classList.remove('hidden');
            quizContent.classList.remove('hidden');
            moduleSummaryScreen.classList.add('hidden');
            finalResultsScreen.classList.add('hidden');
            nextButton.disabled = true;
            
            loadQuestion();
        }

        function loadQuestion() {
            const module = quizData.find(m => m.id === currentModuleId);
            if (!module || currentQuestionIndex >= module.questions.length) {
                showModuleSummary();
                return;
            }

            const question = module.questions[currentQuestionIndex];

            moduleTitle.textContent = `${module.title} (${currentModuleId} de ${totalModules})`;
            questionText.textContent = question.q;
            questionProgress.textContent = `Pregunta ${currentQuestionIndex + 1} de ${module.questions.length}`;
            optionsContainer.innerHTML = '';
            feedbackArea.classList.add('hidden');
            nextButton.disabled = true;
            isAnswered = false;

            updateGlobalProgress();

            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button', 'w-full', 'text-left', 'py-4', 'px-6', 'rounded-lg', 'font-medium', 'bg-gray-50', 'hover:bg-gray-100', 'text-gray-800', 'shadow-sm');
                button.onclick = () => checkAnswer(index, question.answer, question.explanation);
                optionsContainer.appendChild(button);
            });
        }

        function checkAnswer(selectedIndex, correctAnswerIndex, explanation) {
            if (isAnswered) return;
            isAnswered = true;

            trainingData.responses.push({
                moduleId: currentModuleId,
                questionIndex: currentQuestionIndex,
                selectedAnswer: selectedIndex,
                correctAnswer: correctAnswerIndex,
                isCorrect: selectedIndex === correctAnswerIndex,
                timestamp: new Date()
            });

            const options = optionsContainer.querySelectorAll('.option-button');
            options.forEach((button, index) => {
                button.classList.add('disabled');
                if (index === correctAnswerIndex) {
                    button.classList.add('correct-answer');
                } else if (index === selectedIndex && index !== correctAnswerIndex) {
                    button.classList.add('incorrect-answer');
                }
            });

            const isCorrect = selectedIndex === correctAnswerIndex;
            if (isCorrect) {
                moduleScore++;
                feedbackTitle.textContent = 'Respuesta Correcta';
                feedbackTitle.className = 'font-bold text-sm mb-2 text-green-800';
                feedbackArea.className = 'p-4 rounded-xl border bg-green-50 border-green-200';
                feedbackExplanation.textContent = explanation; // Muestra la explicación completa para el caso correcto
                feedbackExplanation.className = 'text-sm text-green-800';
            } else {
                // CORRECCIÓN 1: Asegura la leyenda de Respuesta Incorrecta
                feedbackTitle.textContent = 'Respuesta Incorrecta';
                feedbackTitle.className = 'font-bold text-sm mb-2 text-red-800';
                feedbackArea.className = 'p-4 rounded-xl border bg-red-50 border-red-200';
                
                // Extraer solo la explicación de la respuesta, eliminando el "¡Correcto!" inicial de los datos
                let correctedExplanation = explanation.replace(/^¡Correcto! /, '');
                
                // Añadir el texto de que es incorrecta para el usuario
                feedbackExplanation.textContent = `¡Incorrecto! La respuesta correcta era: ${correctedExplanation}`;
                feedbackExplanation.className = 'text-sm text-red-800';
            }

            nextButton.disabled = false;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        function showModuleSummary() {
            const module = quizData.find(m => m.id === currentModuleId);
            const totalQuestionsModule = module.questions.length;
            const percentage = Math.round((moduleScore / totalQuestionsModule) * 100);
            
            // REGLA 2: Solo agregar si el módulo no ha sido registrado
            if (!moduleResults.some(result => result.id === currentModuleId)) {
                moduleResults.push({
                    id: currentModuleId,
                    title: module.title,
                    score: moduleScore,
                    total: totalQuestionsModule,
                    percentage: percentage
                });
                completedModules++;
            }
            
            quizContent.classList.add('hidden');
            moduleSummaryScreen.classList.remove('hidden');

            moduleSummaryTitle.textContent = module.title;
            moduleScoreDisplay.textContent = `${moduleScore} / ${totalQuestionsModule} (${percentage}%)`;
            
            if (percentage >= 80) {
                moduleSummaryMessage.textContent = `Excelente desempeño en este módulo. Has demostrado dominio sólido de los conceptos.`;
                moduleScoreDisplay.className = 'text-3xl font-black mb-4 text-green-600';
            } else if (percentage >= 60) {
                moduleSummaryMessage.textContent = `Desempeño aceptable. Considera repasar algunos conceptos para fortalecer tu conocimiento.`;
                moduleScoreDisplay.className = 'text-3xl font-black mb-4 text-yellow-600';
            } else {
                moduleSummaryMessage.textContent = `Este módulo requiere atención adicional. Revisa el material antes de continuar.`;
                moduleScoreDisplay.className = 'text-3xl font-black mb-4 text-red-600';
            }
            
            // Usar completedModules para verificar si terminamos
            if (completedModules === totalModules) {
                document.getElementById('continue-button').textContent = 'Ver Resultados Finales';
            } else {
                document.getElementById('continue-button').textContent = 'Continuar al Siguiente Módulo';
            }

            // Actualizar botones para mostrar el estado completado y desbloquear el siguiente
            createModuleButtons();
            updateGlobalProgress(); // Actualizar el progreso final 100%
        }

        function enableNextModule() {
            // Lógica manejada en createModuleButtons() ahora
        }

        function goToNextModule() {
            if (completedModules === totalModules) {
                showFinalResults();
                return;
            }

            // Busca el primer módulo que aún no se haya completado
            const nextModule = quizData.find(m => !moduleResults.some(r => r.id === m.id));

            if (nextModule) {
                currentModuleId = nextModule.id;
                selectModule(currentModuleId);
            } else {
                showFinalResults();
            }
        }
        
        function showFinalResults() {
            quizContent.classList.add('hidden');
            moduleSummaryScreen.classList.add('hidden');
            finalResultsScreen.classList.remove('hidden');

            const endTime = new Date();
            const rawTimeSpentMinutes = (endTime - startTime) / 60000;
            
            // REGLA 3: Recalcular la puntuación final usando SOLO moduleResults para evitar el exceso de 100%
            const calculatedTotalScore = moduleResults.reduce((sum, result) => sum + result.score, 0);
            const calculatedTotalQuestions = moduleResults.reduce((sum, result) => sum + result.total, 0);
            
            const percentage = calculatedTotalQuestions > 0 ? Math.round((calculatedTotalScore / calculatedTotalQuestions) * 100) : 0;
            
            // Actualizar el totalScore global con el valor calculado
            totalScore = calculatedTotalScore;

            // Update RH Dashboard
            document.getElementById('rh-dashboard').classList.remove('hidden');
            document.getElementById('completion-rate').textContent = '100%'; // CORRECCIÓN 2: 100% al finalizar
            document.getElementById('competency-level').textContent = percentage >= 80 ? 'ALTO' : percentage >= 60 ? 'MEDIO' : 'BAJO';
            // CORRECCIÓN 3: Mostrar el tiempo con un decimal
            document.getElementById('time-invested').textContent = `${rawTimeSpentMinutes.toFixed(1)} min`; 

            // Mostrar el puntaje total correcto sobre el total de preguntas de los módulos contestados
            finalScoreDisplay.textContent = `${totalScore} / ${calculatedTotalQuestions} (${percentage}%)`;

            if (percentage >= 80) {
                finalSummaryMessage.textContent = `Resultado sobresaliente. Has demostrado competencia completa en los fundamentos MASH y estás listo para desempeñar funciones supervisoras.`;
                finalScoreDisplay.className = 'text-6xl font-black mb-6 text-green-600';
            } else if (percentage >= 60) {
                finalSummaryMessage.textContent = `Resultado aprobatorio. Tienes una base sólida pero considera reforzar las áreas identificadas para optimizar tu desempeño.`;
                finalScoreDisplay.className = 'text-6xl font-black mb-6 text-yellow-600';
            } else {
                finalSummaryMessage.textContent = `Resultado insuficiente. Requieres estudio adicional del material antes de poder desempeñar funciones supervisoras de manera segura.`;
                finalScoreDisplay.className = 'text-6xl font-black mb-6 text-red-600';
            }
            
            generateResultsDashboard();
        }

        function generateResultsDashboard() {
            let resultsHTML = '<div class="bg-gray-50 rounded-xl p-6 mb-6">';
            resultsHTML += '<h4 class="text-2xl font-bold mb-4 text-gray-800">Análisis Detallado por Módulo</h4>';
            resultsHTML += '<div class="space-y-3">';

            let weakAreas = [];
            let strongAreas = [];

            moduleResults.forEach(result => {
                const colorClass = result.percentage >= 80 ? 'bg-green-100 border-l-4 border-green-500' : 
                                   result.percentage >= 60 ? 'bg-yellow-100 border-l-4 border-yellow-500' : 
                                                            'bg-red-100 border-l-4 border-red-500';
                
                if (result.percentage >= 80) {
                    strongAreas.push(result.title.split(':')[1]?.trim() || result.title);
                } else if (result.percentage < 60) {
                    weakAreas.push(result.title.split(':')[1]?.trim() || result.title);
                }

                resultsHTML += `
                    <div class="p-4 rounded-lg ${colorClass} flex justify-between items-center">
                        <span class="font-medium text-gray-800">${result.title}</span>
                        <!-- Asegurar que el color del texto de la puntuación sea negro (text-gray-800) -->
                        <span class="font-bold text-lg text-gray-800">${result.score} / ${result.total} (${result.percentage}%)</span>
                    </div>
                `;
            });

            resultsHTML += '</div>';

            if (weakAreas.length > 0) {
                resultsHTML += '<div class="mt-6 p-4 bg-red-50 rounded-lg border border-red-200">';
                resultsHTML += '<h5 class="font-bold text-red-800 mb-2">Áreas que Requieren Refuerzo:</h5>';
                resultsHTML += `<p class="text-sm text-red-700">${weakAreas.join(', ')}</p>`;
                resultsHTML += '</div>';
            }

            if (strongAreas.length > 0) {
                resultsHTML += '<div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">';
                resultsHTML += '<h5 class="font-bold text-green-800 mb-2">Fortalezas Identificadas:</h5>';
                resultsHTML += `<p class="text-sm text-green-700">${strongAreas.join(', ')}</p>`;
                resultsHTML += '</div>';
            }

            resultsHTML += '</div>';
            resultsDashboard.innerHTML = resultsHTML;
        }

        function shareResults() {
            const date = new Date().toLocaleDateString('es-MX');
            const time = new Date().toLocaleTimeString('es-MX');
            
            const calculatedTotalScore = moduleResults.reduce((sum, result) => sum + result.score, 0);
            const calculatedTotalQuestions = moduleResults.reduce((sum, result) => sum + result.total, 0);
            const percentage = calculatedTotalQuestions > 0 ? Math.round((calculatedTotalScore / calculatedTotalQuestions) * 100) : 0;
            
            const rawTimeSpentMinutes = (new Date() - startTime) / 60000; // Tiempo en minutos
            
            let moduleSummaryText = '';
            let weakModules = [];
            let strongModules = [];
            
            moduleResults.forEach(result => {
                moduleSummaryText += `\n- ${result.title}: ${result.score}/${result.total} (${result.percentage}%)`;
                
                if (result.percentage >= 80) {
                    strongModules.push(result.title.split(':')[1]?.trim() || result.title);
                } else if (result.percentage < 60) {
                    weakModules.push(result.title.split(':')[1]?.trim() || result.title);
                }
            });

            const competencyLevel = percentage >= 80 ? 'ALTO' : percentage >= 60 ? 'MEDIO' : 'BAJO';
            const status = percentage >= 80 ? 'COMPETENTE' : percentage >= 60 ? 'APROBATORIO' : 'REQUIERE REFUERZO';

            const reportText = `
REPORTE EJECUTIVO - ENTRENAMIENTO SUPERVISOR MASH

DATOS DEL PARTICIPANTE:
Nombre: ${supervisorData.nombre}
Puesto: ${supervisorData.puesto}
Departamento: ${supervisorData.departamento}
Supervisor: ${supervisorData.supervisor || 'No especificado'}
Email: ${supervisorData.email || 'No especificado'}

MÉTRICAS DE ENTRENAMIENTO:
Fecha: ${date} ${time}
Duración: ${rawTimeSpentMinutes.toFixed(1)} minutos
Tasa de Completitud: ${(completedModules / totalModules * 100).toFixed(0)}%

CALIFICACIÓN FINAL:
Aciertos: ${calculatedTotalScore} / ${calculatedTotalQuestions}
Porcentaje: ${percentage}%
Nivel de Competencia: ${competencyLevel}
Status: ${status}

RESULTADOS POR MÓDULO:${moduleSummaryText}

ANÁLISIS DE COMPETENCIAS:
${strongModules.length > 0 ? `Fortalezas: ${strongModules.join(', ')}` : 'Sin fortalezas destacadas'}
${weakModules.length > 0 ? `Requiere refuerzo: ${weakModules.join(', ')}` : 'Sin áreas débiles identificadas'}

RECOMENDACIONES PARA RL:
${percentage >= 80 ? '✓ Empleado competente para funciones supervisoras MASH\n✓ Considerar para roles de mentoring' : 
  percentage >= 60 ? '⚠ Programar refuerzo en áreas identificadas\n⚠ Supervisión adicional recomendada' : 
  '✗ Requiere re-entrenamiento completo\n✗ No apto para funciones supervisoras independientes'}

Reporte generado automáticamente - Sistema MASH v2.0
            `.trim();
            
            shareOutput.textContent = reportText;
            shareOutput.classList.remove('hidden');

            try {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = reportText;
                tempTextArea.style.position = 'fixed';
                tempTextArea.style.opacity = '0';
                document.body.appendChild(tempTextArea);
                
                tempTextArea.focus();
                tempTextArea.select();
                
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                alert('Reporte copiado al portapapeles exitosamente.');

            } catch (err) {
                alert('Por favor, copie manualmente el contenido del recuadro.');
            }
        }

        function generateCertificate() {
            const calculatedTotalScore = moduleResults.reduce((sum, result) => sum + result.score, 0);
            const calculatedTotalQuestions = moduleResults.reduce((sum, result) => sum + result.total, 0);
            const percentage = calculatedTotalQuestions > 0 ? Math.round((calculatedTotalScore / calculatedTotalQuestions) * 100) : 0;
            
            if (percentage < 60) {
                alert('Se requiere una calificación mínima de 60% para generar el certificado.');
                return;
            }

            const certificateContent = `
                <div style="max-width: 800px; margin: 0 auto; background: white; border: 8px solid #0A2463; border-radius: 20px; padding: 60px; text-align: center; font-family: 'Georgia', serif; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    
                    <!-- Header -->
                    <div style="border-bottom: 3px solid #3E92CC; padding-bottom: 30px; margin-bottom: 40px;">
                        <h1 style="color: #0A2463; font-size: 2.5em; font-weight: bold; margin: 0; letter-spacing: 2px;">CERTIFICADO</h1>
                        <h2 style="color: #3E92CC; font-size: 1.5em; margin: 10px 0 0 0; font-weight: normal;">DE COMPETENCIA MASH</h2>
                    </div>
                    
                    <!-- Body -->
                    <div style="margin: 50px 0;">
                        <p style="font-size: 1.2em; color: #555; margin: 0 0 30px 0;">Se certifica que</p>
                        
                        <h3 style="color: #0A2463; font-size: 2.2em; font-weight: bold; margin: 20px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #F4E8C1; padding-bottom: 10px; display: inline-block;">${supervisorData.nombre}</h3>
                        
                        <div style="margin: 30px 0;">
                            <p style="font-size: 1.1em; color: #666; margin: 5px 0;"><strong>${supervisorData.puesto}</strong></p>
                            <p style="font-size: 1.1em; color: #666; margin: 5px 0;">${supervisorData.departamento}</p>
                        </div>
                        
                        <p style="font-size: 1.2em; color: #555; margin: 40px 0 20px 0; line-height: 1.6;">
                            Ha completado satisfactoriamente el<br>
                            <strong style="color: #0A2463;">Entrenamiento de Supervisor MASH</strong><br>
                            con una calificación de
                        </p>
                        
                        <div style="background: linear-gradient(135deg, #3E92CC, #0A2463); color: white; padding: 20px 40px; border-radius: 50px; display: inline-block; margin: 20px 0;">
                            <span style="font-size: 3em; font-weight: bold;">${percentage}%</span>
                        </div>
                        
                        <div style="background: ${percentage >= 80 ? '#10b981' : '#f59e0b'}; color: white; padding: 15px 30px; border-radius: 25px; display: inline-block; margin: 20px 0;">
                            <span style="font-size: 1.3em; font-weight: bold;">NIVEL: ${percentage >= 80 ? 'SOBRESALIENTE' : 'APROBATORIO'}</span>
                        </div>
                    </div>
                    
                    <!-- Competencias -->
                    <div style="background: #f8fafc; padding: 30px; border-radius: 15px; margin: 40px 0; border-left: 6px solid #3E92CC;">
                        <h4 style="color: #0A2463; font-size: 1.3em; margin: 0 0 20px 0; font-weight: bold;">COMPETENCIAS VERIFICADAS</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 10px;"></div>
                                <span style="color: #555; font-size: 1em;">Regulaciones Ambientales Mexicanas</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 10px;"></div>
                                <span style="color: #555; font-size: 1em;">Gestión de Residuos Peligrosos</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 10px;"></div>
                                <span style="color: #555; font-size: 1em;">Control de Emisiones y Descargas</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 10px;"></div>
                                <span style="color: #555; font-size: 1em;">Respuesta a Contingencias Ambientales</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="border-top: 3px solid #3E92CC; padding-top: 30px; margin-top: 50px;">
                        <p style="color: #666; font-size: 1.1em; margin: 0;">
                            <strong style="color: #0A2463;">Fecha de Emisión:</strong> ${new Date().toLocaleDateString('es-MX', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </p>
                        <div style="margin-top: 30px;">
                            <div style="display: inline-block; text-align: center;">
                                <div style="border-top: 2px solid #0A2463; width: 200px; margin: 0 auto 10px auto;"></div>
                                <p style="color: #555; font-size: 0.9em; margin: 0;">Sistema de Capacitación MASH</p>
                            </div>
                        </div>
                    </div>
                    
                </div>
            `;

            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Certificado MASH - ${supervisorData.nombre}</title>
                    <meta charset="UTF-8">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Georgia:wght@400;700&display=swap');
                        body { 
                            margin: 0; 
                            padding: 20px; 
                            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                            min-height: 100vh;
                        }
                        @media print {
                            body { background: white; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${certificateContent}
                    <div style="text-align: center; margin-top: 30px;" class="no-print">
                        <button onclick="window.print()" style="
                            padding: 15px 30px; 
                            background: linear-gradient(135deg, #3E92CC, #0A2463); 
                            color: white; 
                            border: none; 
                            border-radius: 10px; 
                            font-size: 16px; 
                            font-weight: bold; 
                            cursor: pointer;
                            box-shadow: 0 4px 15px rgba(62, 146, 204, 0.3);
                        ">Imprimir Certificado</button>
                    </div>
                </body>
                </html>
            `);
        }

        // Función original sendToRH renombrada y modificada para RL
        function sendToRLClient() {
            const calculatedTotalScore = moduleResults.reduce((sum, result) => sum + result.score, 0);
            const calculatedTotalQuestions = moduleResults.reduce((sum, result) => sum + result.total, 0);
            const percentage = calculatedTotalQuestions > 0 ? Math.round((calculatedTotalScore / calculatedTotalQuestions) * 100) : 0;
            
            const subject = `Entrenamiento MASH - ${supervisorData.nombre}`;
            const body = `El empleado ${supervisorData.nombre} completó el entrenamiento MASH.

Calificación: ${percentage}%
Nivel: ${percentage >= 80 ? 'ALTO' : percentage >= 60 ? 'MEDIO' : 'BAJO'}

Ver reporte completo adjunto.`;
            
            // Reemplazado rh@empresa.com por rl@empresa.com (cambio de RL)
            const mailtoLink = `mailto:rl@empresa.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
        }

        // Función original sendToGmail renombrada y modificada para RL
        function sendToRLGmail() {
            // Se mantuvo la corrección de sintaxis del reduce
            const calculatedTotalScore = moduleResults.reduce((sum, result) => sum + result.score, 0);
            const calculatedTotalQuestions = moduleResults.reduce((sum, result) => sum + result.total, 0);
            const percentage = calculatedTotalQuestions > 0 ? Math.round((calculatedTotalScore / calculatedTotalQuestions) * 100) : 0;
            
            const subject = `Entrenamiento MASH Completado - ${supervisorData.nombre}`;
            // Reemplazado RH en el cuerpo del correo
            const body = `Estimado equipo de RL,

El empleado ${supervisorData.nombre} del departamento ${supervisorData.departamento} ha completado exitosamente el Entrenamiento de Supervisor MASH.

RESULTADOS:
- Calificación Final: ${percentage}%
- Nivel de Competencia: ${percentage >= 80 ? 'ALTO' : percentage >= 60 ? 'MEDIO' : 'BAJO'}
- Status: ${percentage >= 80 ? 'COMPETENTE' : percentage >= 60 ? 'APROBATORIO' : 'REQUIERE REFUERZO'}
- Duración: ${((new Date() - startTime) / 60000).toFixed(1)} minutos

${percentage >= 80 ? 'RECOMENDACIÓN: Empleado listo para funciones supervisoras MASH independientes.' : 
  percentage >= 60 ? 'RECOMENDACIÓN: Programar refuerzo en áreas identificadas antes de funciones independientes.' : 
  'RECOMENDACIÓN: Requiere re-entrenamiento completo antes de asignar responsabilidades supervisoras.'}

El reporte completo y certificado (si aplica) se pueden generar desde el sistema.

Saludos,
Sistema Automatizado de Entrenamiento MASH`;
            
            // Reemplazado rh@empresa.com por rl@empresa.com (cambio de RL)
            const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=rl@empresa.com&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailLink, '_blank');
        }

        function toggleEmailMenu() {
            const menu = document.getElementById('email-menu');
            menu.classList.toggle('hidden');
            
            // Close menu when clicking outside
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('#email-button') && !e.target.closest('#email-menu')) {
                    menu.classList.add('hidden');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // Initialize the application
        initializeApp();
    </script>

</body>
</html>
